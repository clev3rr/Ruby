# Проєкт "Rack-метрики"

* **Виконав:** Малютін Максим

## 1. Опис реалізації

Проєкт реалізовано у вигляді Ruby-гема `rack_metrics`.

* **`lib/rack_metrics/middleware.rb`**: Ядро гема. Це клас Rack Middleware, який перехоплює кожен запит, вимірює час його виконання (`Process.clock_gettime`), аналізує статус відповіді та її розмір (`Content-Length`).
* **`lib/rack_metrics/registry.rb`**: Потоко-безпечний (thread-safe, з використанням `Mutex`) клас-сховище, який акумулює всі метрики. Він підраховує загальну кількість запитів, групує їх за статус-кодами (2xx, 4xx, 5xx) та розподіляє дані про латентність і розмір по "кошиках" (гістограмах).
* Middleware також автоматично відкриває ендпоінт `/metrics` (у демо-версії він змінений на `/my_custom_metrics`), який віддає поточні метрики у текстовому форматі.

## 2. Системні вимоги

Для запуску проєкту необхідні:
1.  **Ruby** (версія 2.6 або вище)
2.  **Bundler** (`gem install bundler`)
3.  **Інструменти для збірки** (оскільки деякі геми мають C-розширення).

Для систем на базі Ubuntu/Debian (включаючи WSL) виконайте:
```bash
sudo apt update
sudo apt install build-essential ruby-dev
````

## 3\. Як запустити та перевірити

Є два способи перевірити працездатність гема: запустити демо-додаток або запустити тести.

### A. Запуск Демонстраційного Додатку (Sinatra + Puma)

Цей спосіб показує гем у реальних умовах.

**1. Встановлення залежностей:**

Перейдіть до папки проєкту та встановіть геми локально:

```bash
# Перехід у папку гема
cd rack_metrics

# Налаштування локальної інсталяції гемів
bundle config set --local path 'vendor/bundle'

# Встановлення
bundle install
```

**2. Створення "ярликів" для запуску:**

Щоб уникнути конфліктів `bundle exec`, створимо локальні файли для запуску:

```bash
bundle binstubs rspec-core
bundle binstubs puma
```

**3. Запуск демо-сервера:**

Файл `config.ru` у корені проєкту описує простий додаток Sinatra, "обгорнутий" нашим middleware `RackMetrics::Middleware`.

```bash
# Запускаємо сервер Puma
./bin/puma
```

Ви маєте побачити: `Listening on tcp://0.0.0.0:9292`

**4. Генерація трафіку:**

Відкрийте **новий термінал** (не закриваючи сервер) і виконайте кілька запитів до різних сторінок:

```bash
# 1. Швидкий запит
curl http://localhost:9292/

# 2. Повільний запит (300ms)
curl http://localhost:9292/slow

# 3. Запит з великою відповіддю (20KB)
curl http://localhost:9292/big

# 4. Запит з помилкою 500
curl http://localhost:9292/error
```

**5. Перегляд метрик:**

Тепер зробіть запит до спеціального шляху `/my_custom_metrics`, який обробляється нашим гемом:

```bash
curl http://localhost:9292/my_custom_metrics
```

**Очікуваний результат:**
Ви побачите звіт, який зібрав гем (точні цифри можуть відрізнятися):

```
requests_total: 5
status_codes_2xx: 4
status_codes_3xx: 0
status_codes_4xx: 0
status_codes_5xx: 1

# Latency Histogram (ms)
latency_le_10: 2
latency_le_50: 1
...
latency_le_500: 2
...

# Response Size Histogram (bytes)
size_le_100: 3
...
size_le_102400: 1
...
```

### B. Запуск Тестів (RSpec)

Для перевірки коректності логіки гема можна запустити автоматизовані тести.

**1. Переконайтеся, що ви виконали крок 1 та 2** (встановлення залежностей та створення `binstubs`).

**2. Запустіть RSpec:**

```bash
./bin/rspec
```

**Очікуваний результат:**
Усі тести мають пройти успішно.

```
RackMetrics::Middleware
  повертає правильний статус та тіло (просто перевірка)
  рахує загальну кількість запитів
  рахує статуси 2xx
  записує латентність у правильний кошик
  записує розмір у правильний кошик
  показує метрики на шляху /metrics

Finished in 0.43581 seconds (files took 11.42 seconds to load)
6 examples, 0 failures
```
